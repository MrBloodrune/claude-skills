<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 Peripherals â€” Reference Implementation</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ===== CSS Custom Properties ===== */
:root {
  --bg-primary: #0a0f1a;
  --bg-secondary: #0d1220;
  --bg-card: #0b1018;
  --bg-card-hover: #10172a;
  --bg-modal: #0a0e18;
  --border-color: #1a2540;
  --border-glow: #d4924b30;
  --copper: #d4924b;
  --copper-dim: #b07a3a;
  --copper-glow: #d4924b80;
  --copper-faint: #d4924b15;
  --green: #4ade80;
  --green-dim: #38b866;
  --green-glow: #4ade8080;
  --green-faint: #4ade8015;
  --red: #ef4444;
  --red-dim: #cc2929;
  --red-glow: #ef444480;
  --red-faint: #ef444415;
  --blue: #60a5fa;
  --blue-dim: #4b8bdb;
  --blue-glow: #60a5fa80;
  --blue-faint: #60a5fa15;
  --text-primary: #e2e8f0;
  --text-secondary: #94a3b8;
  --text-dim: #475569;
  --font-mono: 'JetBrains Mono', 'Courier New', monospace;
  --font-body: 'Instrument Sans', -apple-system, sans-serif;
  --nav-width: 280px;
  --nav-collapsed: 48px;
  --transition-fast: 150ms ease;
  --transition-med: 300ms ease;
  --transition-slow: 500ms ease;
  --trace-color: #d4924b12;
  --grid-color: #d4924b08;
  --pad-color: #d4924b30;
  --z-nav: 100;
  --z-modal-backdrop: 200;
  --z-modal: 201;
}

/* ===== Reset & Base ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
  scroll-behavior: smooth;
  scrollbar-width: thin;
  scrollbar-color: var(--copper-dim) var(--bg-secondary);
}

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  line-height: 1.7;
  font-size: 15px;
  overflow-x: hidden;
  min-height: 100vh;
}

::selection {
  background: var(--copper-faint);
  color: var(--copper);
}

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-secondary); }
::-webkit-scrollbar-thumb { background: var(--copper-dim); border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: var(--copper); }

/* ===== Reduced Motion ===== */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
body.reduce-motion *, body.reduce-motion *::before, body.reduce-motion *::after {
  animation-duration: 0.01ms !important;
  animation-iteration-count: 1 !important;
  transition-duration: 0.01ms !important;
}

/* ===== Focus ===== */
*:focus-visible {
  outline: 2px solid var(--copper);
  outline-offset: 2px;
}

/* ===== Copper Trace Grid Background ===== */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 0;
  background-image:
    linear-gradient(var(--grid-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
  background-size: 40px 40px;
  opacity: 0.6;
}

/* ===== Silkscreen Overlay ===== */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 9999;
  background: repeating-linear-gradient(
    0deg,
    transparent,
    transparent 3px,
    rgba(10, 15, 26, 0.015) 3px,
    rgba(10, 15, 26, 0.015) 4px
  );
}

.grid-bg {
  background-image:
    radial-gradient(circle at 50% 50%, var(--copper-faint) 0%, transparent 70%),
    linear-gradient(var(--grid-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
  background-size: 100% 100%, 40px 40px, 40px 40px;
}

/* ===== Solder Pad Dots ===== */
.pad-dot {
  display: inline-block;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--copper);
  box-shadow: 0 0 4px var(--copper-glow);
  flex-shrink: 0;
}
.pad-dot.sm { width: 5px; height: 5px; }

/* ===== Navigation Sidebar ===== */
.nav-sidebar {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: var(--nav-width);
  background: rgba(10, 15, 26, 0.92);
  border-right: 1px solid rgba(212, 146, 75, 0.15);
  box-shadow: 1px 0 12px rgba(212, 146, 75, 0.06), inset -1px 0 0 rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  z-index: var(--z-nav);
  display: flex;
  flex-direction: column;
  transition: width var(--transition-med), transform var(--transition-med);
  overflow-x: hidden;
  overflow-y: auto;
}
.nav-sidebar.collapsed { width: var(--nav-collapsed); }
.nav-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-bottom: 1px solid var(--border-color);
  min-height: 56px;
}
.nav-title {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 600;
  color: var(--copper);
  text-shadow: 0 0 8px var(--copper-glow);
  white-space: nowrap;
  overflow: hidden;
  transition: opacity var(--transition-fast);
  letter-spacing: 2px;
  text-transform: uppercase;
}
.collapsed .nav-title { opacity: 0; width: 0; }
.nav-toggle {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--copper);
  width: 28px;
  height: 28px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  border-radius: 2px;
  transition: background var(--transition-fast), border-color var(--transition-fast);
}
.nav-toggle:hover {
  background: var(--copper-faint);
  border-color: var(--copper-dim);
}
.nav-toggle svg {
  width: 14px;
  height: 14px;
  transition: transform var(--transition-med);
}
.collapsed .nav-toggle svg {
  transform: rotate(180deg);
}

.nav-section-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 2px;
  padding: 10px 16px 2px;
  white-space: nowrap;
  overflow: hidden;
}
.collapsed .nav-section-label { opacity: 0; }

.nav-links {
  list-style: none;
  padding: 2px 0;
  flex: none;
}
.nav-links li { position: relative; }
.nav-links a {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 5px 16px;
  color: var(--text-secondary);
  text-decoration: none;
  font-family: var(--font-mono);
  font-size: 12px;
  white-space: nowrap;
  transition: color var(--transition-fast), background var(--transition-fast);
  border-left: 2px solid transparent;
}
.nav-links a:hover, .nav-links a.active {
  color: var(--copper);
  background: var(--copper-faint);
  border-left-color: var(--copper);
}
.nav-links a .nav-icon {
  width: 16px;
  text-align: center;
  flex-shrink: 0;
  font-size: 13px;
}
.nav-links a .nav-label {
  overflow: hidden;
  transition: opacity var(--transition-fast);
}
.collapsed .nav-label { opacity: 0; }

.nav-controls {
  padding: 12px 16px;
  border-top: 1px solid var(--border-color);
  margin-top: auto;
}
.motion-toggle {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  padding: 6px 10px;
  font-family: var(--font-mono);
  font-size: 11px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
  border-radius: 2px;
  width: 100%;
  transition: color var(--transition-fast), border-color var(--transition-fast);
}
.motion-toggle:hover {
  color: var(--copper);
  border-color: var(--copper-dim);
}
.motion-toggle .toggle-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green-glow);
  flex-shrink: 0;
  transition: background var(--transition-fast), box-shadow var(--transition-fast);
}
.motion-toggle.paused .toggle-dot {
  background: var(--red);
  box-shadow: 0 0 6px var(--red-glow);
}
.collapsed .motion-label { opacity: 0; }

/* ===== Main Content ===== */
.main-content {
  margin-left: var(--nav-width);
  transition: margin-left var(--transition-med);
  min-height: 100vh;
  position: relative;
  z-index: 1;
}
.nav-sidebar.collapsed ~ .main-content {
  margin-left: var(--nav-collapsed);
}

/* ===== Hero Section ===== */
.hero {
  position: relative;
  padding: 100px 48px 80px;
  text-align: center;
  overflow: hidden;
  border-bottom: 1px solid var(--border-color);
}
.hero::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse at 50% 50%, var(--copper-faint) 0%, transparent 70%),
    linear-gradient(var(--grid-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
  background-size: 100% 100%, 40px 40px, 40px 40px;
}
.hero-content { position: relative; z-index: 1; }
.hero-chip {
  display: inline-block;
  border: 2px solid var(--copper);
  border-radius: 4px;
  padding: 16px 32px;
  margin-bottom: 24px;
  position: relative;
  box-shadow: 0 0 20px var(--copper-faint), inset 0 0 20px rgba(10,15,26,0.8);
}
.hero-chip::before,
.hero-chip::after {
  content: '';
  position: absolute;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--copper);
  box-shadow: 0 0 6px var(--copper-glow);
}
.hero-chip::before { top: -3px; left: 20px; }
.hero-chip::after { bottom: -3px; right: 20px; }
.hero-title {
  font-family: var(--font-mono);
  font-size: clamp(32px, 6vw, 56px);
  font-weight: 600;
  color: var(--copper);
  text-shadow:
    0 0 10px var(--copper-glow),
    0 0 30px var(--copper-glow),
    0 0 60px rgba(212, 146, 75, 0.2);
  letter-spacing: 3px;
  animation: copper-pulse 4s infinite;
  margin-bottom: 4px;
  text-transform: uppercase;
}
@keyframes copper-pulse {
  0%, 97%, 100% { opacity: 1; }
  97.5% { opacity: 0.9; }
  98% { opacity: 1; }
  98.5% { opacity: 0.95; }
}
.hero-subtitle {
  font-family: var(--font-body);
  font-size: clamp(14px, 2vw, 18px);
  color: var(--text-secondary);
  margin-bottom: 24px;
  font-weight: 400;
}
.hero-tagline {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--green);
  text-shadow: 0 0 6px var(--green-glow);
  display: inline-block;
  border: 1px solid var(--green-faint);
  padding: 6px 16px;
  letter-spacing: 1px;
}
.hero-tagline::before { content: '// '; color: var(--text-dim); }
.hero-stats {
  display: flex;
  gap: 48px;
  justify-content: center;
  margin-top: 40px;
}
.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}
.stat-value {
  font-family: var(--font-mono);
  font-size: 32px;
  font-weight: 600;
  color: var(--copper);
  text-shadow: 0 0 8px var(--copper-glow);
}
.stat-label {
  font-family: var(--font-mono);
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-secondary);
}

/* ===== Category Headers ===== */
.category-header {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--copper);
  text-transform: uppercase;
  letter-spacing: 3px;
  padding: 24px 0 8px;
  border-bottom: 1px solid var(--border-color);
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.category-header::before {
  content: '';
  width: 24px;
  height: 1px;
  background: var(--copper);
  box-shadow: 0 0 4px var(--copper-glow);
}
.category-header .pad-dot { margin-left: auto; }

/* ===== Section Cards ===== */
.sections-container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 48px 32px 80px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.section-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 2px;
  overflow: hidden;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
  position: relative;
}
.section-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 3px;
  height: 100%;
  background: var(--copper-dim);
  opacity: 0;
  transition: opacity var(--transition-fast);
}
.section-card:hover::before,
.section-card.expanded::before { opacity: 1; }
.section-card:hover {
  border-color: var(--copper-dim);
  box-shadow: 0 0 12px var(--copper-faint);
}
.section-card.expanded { border-color: var(--copper-dim); }

.card-header {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px 24px;
  cursor: pointer;
  user-select: none;
  transition: background var(--transition-fast);
}
.card-header:hover { background: var(--bg-card-hover); }
.card-header:focus-visible {
  outline: 2px solid var(--copper);
  outline-offset: -2px;
}
.card-index {
  font-family: var(--font-mono);
  font-size: 24px;
  font-weight: 600;
  color: var(--copper-dim);
  text-shadow: 0 0 6px var(--copper-faint);
  width: 36px;
  text-align: center;
  flex-shrink: 0;
}
.card-info { flex: 1; }
.card-title {
  font-family: var(--font-mono);
  font-size: 16px;
  font-weight: 500;
  color: var(--copper);
  text-shadow: 0 0 4px var(--copper-faint);
  margin-bottom: 4px;
}
.card-pattern-label {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--blue);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 2px;
}
.card-summary {
  font-size: 13px;
  color: var(--text-secondary);
}
.card-expand-icon {
  color: var(--text-dim);
  transition: transform var(--transition-med), color var(--transition-fast);
  flex-shrink: 0;
}
.section-card.expanded .card-expand-icon {
  transform: rotate(90deg);
  color: var(--copper);
}
.card-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height var(--transition-slow);
}
.section-card.expanded .card-body { max-height: 8000px; }
.card-content {
  padding: 0 24px 32px;
  border-top: 1px solid var(--border-color);
}

/* ===== Content Styles ===== */
.content-block { margin-top: 24px; }
.content-block h3 {
  font-family: var(--font-mono);
  font-size: 14px;
  font-weight: 500;
  color: var(--copper);
  text-shadow: 0 0 4px var(--copper-faint);
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.content-block h3::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--copper);
  box-shadow: 0 0 4px var(--copper-glow);
  flex-shrink: 0;
}
.content-block p {
  margin-bottom: 12px;
  color: var(--text-primary);
  font-size: 14px;
  line-height: 1.8;
}
.content-block ul {
  list-style: none;
  padding-left: 0;
  margin-bottom: 12px;
}
.content-block li {
  padding: 4px 0 4px 20px;
  position: relative;
  font-size: 14px;
  color: var(--text-primary);
}
.content-block li::before {
  content: '\25C6';
  position: absolute;
  left: 0;
  color: var(--copper-dim);
  font-size: 8px;
  top: 8px;
}

/* Silkscreen labels */
.silkscreen {
  font-family: var(--font-mono);
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
}

/* Code blocks */
.code-block {
  background: #060a12;
  border: 1px solid var(--border-color);
  border-radius: 2px;
  padding: 16px;
  margin: 12px 0;
  overflow-x: auto;
  font-family: var(--font-mono);
  font-size: 13px;
  line-height: 1.6;
  color: var(--text-primary);
}
.code-block .kw { color: var(--blue); }
.code-block .fn { color: var(--copper); }
.code-block .str { color: var(--green); }
.code-block .cmt { color: var(--text-dim); font-style: italic; }
.code-block .num { color: #d19a66; }
.code-block .type { color: #e5c07b; }
.code-block .macro { color: #c678dd; }

/* ===== Deep Dive Buttons ===== */
.deep-dive-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: none;
  border: 1px solid var(--blue-dim);
  color: var(--blue);
  padding: 8px 16px;
  font-family: var(--font-mono);
  font-size: 12px;
  cursor: pointer;
  margin: 8px 8px 8px 0;
  border-radius: 2px;
  transition: all var(--transition-fast);
  text-shadow: 0 0 4px var(--blue-faint);
}
.deep-dive-btn:hover {
  background: var(--blue-faint);
  box-shadow: 0 0 10px var(--blue-faint);
  text-shadow: 0 0 6px var(--blue-glow);
}
.deep-dive-btn::before { content: '['; color: var(--text-dim); }
.deep-dive-btn::after { content: ']'; color: var(--text-dim); }

/* ===== Modal ===== */
.modal-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(4px);
  z-index: var(--z-modal-backdrop);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--transition-med), visibility var(--transition-med);
}
.modal-backdrop.visible { opacity: 1; visibility: visible; }
.modal {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.92);
  width: min(720px, 90vw);
  max-height: 85vh;
  background: var(--bg-modal);
  border: 1px solid var(--copper-dim);
  box-shadow: 0 0 30px var(--copper-faint), 0 0 60px rgba(0,0,0,0.8);
  z-index: var(--z-modal);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--transition-med), visibility var(--transition-med), transform var(--transition-med);
  display: flex;
  flex-direction: column;
  border-radius: 2px;
}
.modal.visible {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}
.modal-titlebar {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
  gap: 12px;
  flex-shrink: 0;
}
.modal-dots { display: flex; gap: 6px; }
.modal-dots span {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 1px solid var(--border-color);
  display: block;
}
.modal-dots span:nth-child(1) { background: var(--red-dim); border-color: var(--red-dim); }
.modal-dots span:nth-child(2) { background: var(--copper-dim); border-color: var(--copper-dim); }
.modal-dots span:nth-child(3) { background: var(--green-dim); border-color: var(--green-dim); }
.modal-title-text {
  font-family: var(--font-mono);
  font-size: 13px;
  color: var(--text-secondary);
  flex: 1;
}
.modal-close {
  background: none;
  border: none;
  color: var(--text-dim);
  font-size: 20px;
  cursor: pointer;
  padding: 0 4px;
  line-height: 1;
  transition: color var(--transition-fast);
}
.modal-close:hover { color: var(--red); }
.modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}
.modal-body h4 {
  font-family: var(--font-mono);
  color: var(--copper);
  font-size: 15px;
  margin-bottom: 12px;
}
.modal-body p, .modal-body li {
  font-size: 14px;
  line-height: 1.8;
  color: var(--text-primary);
  margin-bottom: 10px;
}
.modal-body ul { list-style: none; padding: 0; }
.modal-body li { padding-left: 20px; position: relative; }
.modal-body li::before {
  content: '\25C6';
  position: absolute;
  left: 0;
  color: var(--copper-dim);
  font-size: 8px;
  top: 6px;
}
.modal-body .warn {
  border-left: 3px solid var(--red);
  padding: 12px 16px;
  background: var(--red-faint);
  margin: 12px 0;
  font-size: 13px;
}
.modal-body .warn::before {
  content: 'NOTE: ';
  font-family: var(--font-mono);
  color: var(--red);
  font-weight: 600;
}
.modal-body .code-block { margin: 12px 0; }

/* ===== Visualization Containers ===== */
.viz-container {
  background: #060a12;
  border: 1px solid var(--border-color);
  border-radius: 2px;
  margin: 20px 0;
  overflow: hidden;
}
.viz-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 16px;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-color);
}
.viz-label {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.viz-label::before {
  content: '';
  width: 5px;
  height: 5px;
  border-radius: 50%;
  background: var(--copper);
  box-shadow: 0 0 3px var(--copper-glow);
}
.viz-controls { display: flex; gap: 8px; }
.viz-btn {
  background: none;
  border: 1px solid var(--border-color);
  color: var(--text-secondary);
  font-family: var(--font-mono);
  font-size: 11px;
  padding: 3px 10px;
  cursor: pointer;
  border-radius: 2px;
  transition: all var(--transition-fast);
}
.viz-btn:hover { border-color: var(--copper-dim); color: var(--copper); }
.viz-btn.active {
  border-color: var(--copper);
  color: var(--copper);
  background: var(--copper-faint);
}
.viz-canvas {
  position: relative;
  min-height: 200px;
  padding: 24px;
  background:
    linear-gradient(var(--grid-color) 1px, transparent 1px),
    linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
  background-size: 20px 20px;
}

/* ===== PWM Visualization ===== */
.pwm-viz { display: flex; flex-direction: column; gap: 4px; }
.pwm-channel { display: flex; align-items: center; gap: 10px; height: 44px; }
.pwm-label {
  font-family: var(--font-mono);
  font-size: 11px;
  width: 90px;
  text-align: right;
  flex-shrink: 0;
  color: var(--text-secondary);
}
.pwm-label .duty { color: var(--copper); font-size: 10px; }
.pwm-track {
  flex: 1;
  height: 36px;
  position: relative;
  border: 1px solid var(--border-color);
  border-radius: 2px;
  overflow: hidden;
  background: rgba(0,0,0,0.3);
}
.pwm-blocks { position: absolute; inset: 0; display: flex; align-items: stretch; }
.pwm-block { height: 100%; flex-shrink: 0; }
.pwm-cursor {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 2px;
  background: var(--copper);
  box-shadow: 0 0 8px var(--copper-glow);
  z-index: 5;
  pointer-events: none;
}
.pwm-time-scale { display: flex; align-items: center; gap: 10px; margin-top: 4px; }
.pwm-time-label { width: 90px; flex-shrink: 0; }
.pwm-time-track {
  flex: 1;
  display: flex;
  justify-content: space-between;
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-dim);
}

/* ===== State Machine ===== */
.fsm-viz { position: relative; min-height: 300px; }
.fsm-node {
  position: absolute;
  padding: 10px 18px;
  border: 2px solid var(--border-color);
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-secondary);
  background: var(--bg-card);
  text-align: center;
  transition: all 0.3s;
  z-index: 2;
  cursor: default;
}
.fsm-node.active {
  border-color: var(--green);
  color: var(--green);
  background: var(--green-faint);
  box-shadow: 0 0 16px var(--green-faint), 0 0 32px rgba(74,222,128,0.1);
  animation: fsm-glow 1.5s infinite;
}
.fsm-node.error-state.active {
  border-color: var(--red);
  color: var(--red);
  background: var(--red-faint);
  box-shadow: 0 0 16px var(--red-faint);
  animation: fsm-glow-red 1.5s infinite;
}
@keyframes fsm-glow {
  0%, 100% { box-shadow: 0 0 12px var(--green-faint); }
  50% { box-shadow: 0 0 24px var(--green-glow); }
}
@keyframes fsm-glow-red {
  0%, 100% { box-shadow: 0 0 12px var(--red-faint); }
  50% { box-shadow: 0 0 24px var(--red-glow); }
}
.fsm-svg {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  z-index: 1;
  pointer-events: none;
}
.fsm-svg line {
  stroke: var(--border-color);
  stroke-width: 1.5;
  fill: none;
  transition: stroke 0.3s, stroke-width 0.3s;
}
.fsm-svg line.active {
  stroke: var(--green);
  stroke-width: 2;
  filter: drop-shadow(0 0 4px var(--green-glow));
}
.fsm-event-log {
  font-family: var(--font-mono);
  font-size: 11px;
  color: var(--text-dim);
  margin-top: 12px;
  padding: 8px 12px;
  border: 1px solid var(--border-color);
  border-radius: 2px;
  background: rgba(0,0,0,0.3);
  min-height: 24px;
  overflow: hidden;
}
.fsm-event-log .event-text { color: var(--green); }

/* ===== GPIO Register ===== */
.gpio-reg-viz { display: flex; flex-direction: column; gap: 20px; }
.gpio-bits-row { display: flex; gap: 4px; justify-content: center; }
.gpio-bit {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  cursor: pointer;
  user-select: none;
}
.gpio-bit-box {
  width: 48px;
  height: 40px;
  border: 2px solid var(--border-color);
  border-radius: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 16px;
  font-weight: 600;
  color: var(--text-dim);
  background: rgba(0,0,0,0.3);
  transition: all 0.15s;
}
.gpio-bit-box.set {
  border-color: var(--copper);
  color: var(--copper);
  background: var(--copper-faint);
  box-shadow: 0 0 8px var(--copper-faint);
}
.gpio-bit-label {
  font-family: var(--font-mono);
  font-size: 8px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  max-width: 48px;
  line-height: 1.2;
}
.gpio-bit-num {
  font-family: var(--font-mono);
  font-size: 9px;
  color: var(--text-dim);
}
.gpio-preview {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 24px;
  padding: 16px;
  border: 1px solid var(--border-color);
  border-radius: 2px;
  background: rgba(0,0,0,0.3);
  min-height: 80px;
  flex-wrap: wrap;
}
.gpio-preview-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
  font-family: var(--font-mono);
  font-size: 11px;
}
.gpio-preview-label { color: var(--text-dim); font-size: 9px; text-transform: uppercase; letter-spacing: 1px; }
.gpio-preview-val { color: var(--copper); font-weight: 500; }
.gpio-preview-val.active { color: var(--green); }
.gpio-preview-val.disabled { color: var(--red-dim); }
.gpio-pin-graphic {
  width: 60px;
  height: 60px;
  border: 2px solid var(--border-color);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--font-mono);
  font-size: 18px;
  color: var(--text-dim);
  transition: all 0.2s;
}
.gpio-pin-graphic.output { border-color: var(--green); color: var(--green); }
.gpio-pin-graphic.input { border-color: var(--blue); color: var(--blue); }
.gpio-pin-graphic.od { border-color: var(--copper); color: var(--copper); }
.gpio-pin-graphic.off { border-color: var(--text-dim); color: var(--text-dim); opacity: 0.4; }

/* ===== Footer ===== */
.site-footer {
  padding: 32px;
  border-top: 1px solid var(--border-color);
  text-align: center;
}
.site-footer .pad-dot {
  margin: 0 8px 16px;
}
.site-footer p {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 8px;
}
.site-footer a {
  color: var(--blue-dim);
  text-decoration: none;
}
.site-footer a:hover {
  color: var(--blue);
  text-shadow: 0 0 4px var(--blue-faint);
}

/* ===== Responsive ===== */
.mobile-nav-btn {
  display: none;
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 101;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  color: var(--copper);
  width: 36px;
  height: 36px;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  cursor: pointer;
  border-radius: 2px;
}
.mobile-nav-btn:hover {
  border-color: var(--copper-dim);
  box-shadow: 0 0 8px var(--copper-faint);
}

@media (max-width: 768px) {
  .nav-sidebar {
    transform: translateX(-100%);
    width: var(--nav-width);
  }
  .nav-sidebar.mobile-open { transform: translateX(0); }
  .main-content { margin-left: 0 !important; }
  .mobile-nav-btn { display: flex !important; }
  .hero { padding: 60px 24px 48px; }
  .sections-container { padding: 24px 16px 48px; }
  .card-header { padding: 16px; }
  .card-content { padding: 0 16px 24px; }
  .pwm-label { font-size: 9px; width: 60px; }
  .fsm-viz { min-height: 350px; }
  .modal { width: min(720px, 95vw); max-height: 90vh; }
  .hero-stats { gap: 32px; }
  .viz-label { font-size: 10px; }
}
</style>
</head>
<body>

<!-- Mobile nav button -->
<button class="mobile-nav-btn" onclick="document.querySelector('.nav-sidebar').classList.toggle('mobile-open')" aria-label="Toggle navigation">
  <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M2 4h14M2 9h14M2 14h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
</button>

<!-- Navigation Sidebar -->
<nav class="nav-sidebar" aria-label="Main navigation">
  <div class="nav-header">
    <span class="nav-title">Peripherals</span>
    <button class="nav-toggle" onclick="toggleNav()" aria-label="Collapse navigation">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M9 3L5 7l4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
  </div>
  <div class="nav-section-label">Timing &amp; Sequential</div>
  <ul class="nav-links">
    <li><a href="#hero"><span class="nav-icon">&#9632;</span><span class="nav-label">Overview</span></a></li>
    <li><a href="#pwm"><span class="nav-icon">&#9080;</span><span class="nav-label">PWM Generation</span></a></li>
  </ul>
  <div class="nav-section-label">State &amp; Flow</div>
  <ul class="nav-links">
    <li><a href="#wifi-fsm"><span class="nav-icon">&#9673;</span><span class="nav-label">WiFi State Machine</span></a></li>
    <li><a href="#gpio-reg"><span class="nav-icon">&#9638;</span><span class="nav-label">GPIO Register</span></a></li>
  </ul>
  <div class="nav-controls">
    <button class="motion-toggle" id="motionToggle" onclick="toggleMotion()" aria-label="Toggle animations">
      <span class="toggle-dot"></span>
      <span class="motion-label">Animations ON</span>
    </button>
  </div>
</nav>

<!-- Modal backdrop -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeModal()"></div>
<!-- Modal -->
<div class="modal" id="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitleText">
  <div class="modal-titlebar">
    <div class="modal-dots"><span></span><span></span><span></span></div>
    <span class="modal-title-text" id="modalTitleText">Deep Dive</span>
    <button class="modal-close" onclick="closeModal()" aria-label="Close modal">&times;</button>
  </div>
  <div class="modal-body" id="modalBody"></div>
</div>

<!-- Main Content -->
<main class="main-content">

  <!-- Hero -->
  <section class="hero grid-bg" id="hero">
    <div class="hero-content">
      <div class="hero-chip">
        <h1 class="hero-title">ESP32</h1>
      </div>
      <p class="hero-subtitle">Peripherals &amp; Communication Protocols</p>
      <span class="hero-tagline">Interactive Visual Guide to Hardware Interfaces</span>
      <div class="hero-stats">
        <div class="stat-item">
          <span class="stat-value">3</span>
          <span class="stat-label">Patterns</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">3</span>
          <span class="stat-label">Visualizations</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">3</span>
          <span class="stat-label">Deep Dives</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Sections -->
  <div class="sections-container">

    <div class="category-header">
      Timing &amp; Sequential Patterns
      <span class="pad-dot"></span>
    </div>

    <!-- ====== 1. PWM Signal Generation ====== -->
    <article class="section-card" id="pwm">
      <div class="card-header" onclick="toggleCard(this)" role="button" tabindex="0" aria-expanded="false" aria-controls="pwm-body">
        <span class="card-index">01</span>
        <div class="card-info">
          <span class="card-pattern-label">Playhead / Sweep</span>
          <h2 class="card-title">PWM Signal Generation</h2>
          <p class="card-summary">Pulse-width modulation channels at varying duty cycles with real-time sweep cursor</p>
        </div>
        <svg class="card-expand-icon" width="12" height="12" viewBox="0 0 12 12"><path d="M 2 2 L 10 6 L 2 10 Z" fill="currentColor"/></svg>
      </div>
      <div class="card-body" id="pwm-body">
        <div class="card-content">

          <div class="content-block">
            <h3>How PWM Works on ESP32</h3>
            <p>The ESP32 has a dedicated <strong>LED Control (LEDC)</strong> peripheral with 16 independent PWM channels. Each channel has a configurable timer, frequency, and duty cycle resolution up to 20 bits. The duty cycle determines what fraction of each period the signal stays HIGH.</p>
            <p>Below, three channels run at 25%, 50%, and 75% duty cycle. The sweep cursor leads and the HIGH/LOW blocks trail behind it, showing the waveform as it would appear on an oscilloscope.</p>
          </div>

          <div class="viz-container" id="pwmViz">
            <div class="viz-header">
              <span class="viz-label">PWM Output Channels</span>
              <div class="viz-controls">
                <button class="viz-btn active" id="pwmPlayBtn" onclick="pwmToggle()" aria-label="Play or pause PWM animation">Pause</button>
                <button class="viz-btn" onclick="pwmReset()" aria-label="Reset PWM animation">Reset</button>
              </div>
            </div>
            <div class="viz-canvas">
              <div class="pwm-viz" id="pwmCanvas">
                <div class="pwm-channel">
                  <div class="pwm-label">CH0 <span class="duty">25%</span></div>
                  <div class="pwm-track" id="pwmTrack0">
                    <div class="pwm-blocks" id="pwmBlocks0"></div>
                    <div class="pwm-cursor" id="pwmCursor0"></div>
                  </div>
                </div>
                <div class="pwm-channel">
                  <div class="pwm-label">CH1 <span class="duty">50%</span></div>
                  <div class="pwm-track" id="pwmTrack1">
                    <div class="pwm-blocks" id="pwmBlocks1"></div>
                    <div class="pwm-cursor" id="pwmCursor1"></div>
                  </div>
                </div>
                <div class="pwm-channel">
                  <div class="pwm-label">CH2 <span class="duty">75%</span></div>
                  <div class="pwm-track" id="pwmTrack2">
                    <div class="pwm-blocks" id="pwmBlocks2"></div>
                    <div class="pwm-cursor" id="pwmCursor2"></div>
                  </div>
                </div>
                <div class="pwm-time-scale">
                  <div class="pwm-time-label"></div>
                  <div class="pwm-time-track">
                    <span>0</span><span>T/4</span><span>T/2</span><span>3T/4</span><span>T</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="content-block">
            <h3>ESP-IDF Configuration</h3>
            <div class="code-block"><span class="cmt">// Configure LEDC timer</span>
<span class="type">ledc_timer_config_t</span> timer = {
    .<span class="fn">speed_mode</span> = <span class="macro">LEDC_LOW_SPEED_MODE</span>,
    .<span class="fn">timer_num</span>  = <span class="macro">LEDC_TIMER_0</span>,
    .<span class="fn">duty_resolution</span> = <span class="macro">LEDC_TIMER_13_BIT</span>,
    .<span class="fn">freq_hz</span>    = <span class="num">5000</span>,
    .<span class="fn">clk_cfg</span>    = <span class="macro">LEDC_AUTO_CLK</span>,
};
<span class="fn">ledc_timer_config</span>(&amp;timer);

<span class="cmt">// Configure channel at 50% duty</span>
<span class="type">ledc_channel_config_t</span> ch = {
    .<span class="fn">gpio_num</span>   = <span class="num">18</span>,
    .<span class="fn">speed_mode</span> = <span class="macro">LEDC_LOW_SPEED_MODE</span>,
    .<span class="fn">channel</span>    = <span class="macro">LEDC_CHANNEL_0</span>,
    .<span class="fn">timer_sel</span>  = <span class="macro">LEDC_TIMER_0</span>,
    .<span class="fn">duty</span>       = <span class="num">4096</span>, <span class="cmt">// 50% of 8192 (13-bit)</span>
};
<span class="fn">ledc_channel_config</span>(&amp;ch);</div>
          </div>

          <button class="deep-dive-btn" onclick="openModal('pwm-modal')" aria-label="Deep dive into PWM details">PWM Resolution &amp; Frequency</button>
        </div>
      </div>
    </article>

    <!-- ====== STATE & FLOW PATTERNS ====== -->
    <div class="category-header">
      State &amp; Flow Patterns
      <span class="pad-dot"></span>
    </div>

    <!-- ====== 2. WiFi Connection FSM ====== -->
    <article class="section-card" id="wifi-fsm">
      <div class="card-header" onclick="toggleCard(this)" role="button" tabindex="0" aria-expanded="false" aria-controls="wifi-body">
        <span class="card-index">02</span>
        <div class="card-info">
          <span class="card-pattern-label">State Machine</span>
          <h2 class="card-title">WiFi Connection FSM</h2>
          <p class="card-summary">Finite state machine for WiFi lifecycle: scan, connect, disconnect, error recovery</p>
        </div>
        <svg class="card-expand-icon" width="12" height="12" viewBox="0 0 12 12"><path d="M 2 2 L 10 6 L 2 10 Z" fill="currentColor"/></svg>
      </div>
      <div class="card-body" id="wifi-body">
        <div class="card-content">

          <div class="content-block">
            <h3>WiFi Connection Lifecycle</h3>
            <p>The ESP32 WiFi subsystem follows a well-defined state machine. From <strong>IDLE</strong>, the station scans for access points, attempts connection with the selected SSID, and transitions through authentication and association phases. Disconnections can happen due to AP going away, auth failures, or signal loss.</p>
            <p>The visualization below auto-plays a typical connection scenario, showing state transitions and the events that trigger them.</p>
          </div>

          <div class="viz-container" id="wifiViz">
            <div class="viz-header">
              <span class="viz-label">WiFi Connection State Machine</span>
              <div class="viz-controls">
                <button class="viz-btn active" id="wifiPlayBtn" onclick="wifiToggle()" aria-label="Play or pause WiFi FSM animation">Pause</button>
                <button class="viz-btn" onclick="wifiReset()" aria-label="Reset WiFi FSM animation">Reset</button>
              </div>
            </div>
            <div class="viz-canvas">
              <div class="fsm-viz" id="wifiCanvas"></div>
              <div class="fsm-event-log" id="wifiEventLog">
                <span class="silkscreen">Event: </span><span class="event-text" id="wifiEventText">Waiting...</span>
              </div>
            </div>
          </div>

          <div class="content-block">
            <h3>ESP-IDF WiFi Events</h3>
            <div class="code-block"><span class="cmt">// Register event handlers</span>
<span class="fn">esp_event_handler_register</span>(
    <span class="macro">WIFI_EVENT</span>, <span class="macro">ESP_EVENT_ANY_ID</span>,
    &amp;wifi_event_handler, <span class="macro">NULL</span>);
<span class="fn">esp_event_handler_register</span>(
    <span class="macro">IP_EVENT</span>, <span class="macro">IP_EVENT_STA_GOT_IP</span>,
    &amp;ip_event_handler, <span class="macro">NULL</span>);

<span class="cmt">// Key events:</span>
<span class="cmt">// WIFI_EVENT_STA_START       -> call esp_wifi_connect()</span>
<span class="cmt">// WIFI_EVENT_STA_CONNECTED   -> waiting for IP</span>
<span class="cmt">// IP_EVENT_STA_GOT_IP        -> fully connected</span>
<span class="cmt">// WIFI_EVENT_STA_DISCONNECTED -> retry or fail</span></div>
          </div>

          <button class="deep-dive-btn" onclick="openModal('wifi-modal')" aria-label="Deep dive into WiFi events">WiFi Events Reference</button>
        </div>
      </div>
    </article>

    <!-- ====== 3. GPIO Configuration Register ====== -->
    <article class="section-card" id="gpio-reg">
      <div class="card-header" onclick="toggleCard(this)" role="button" tabindex="0" aria-expanded="false" aria-controls="gpio-reg-body">
        <span class="card-index">03</span>
        <div class="card-info">
          <span class="card-pattern-label">Bit Register</span>
          <h2 class="card-title">GPIO Configuration Register</h2>
          <p class="card-summary">Interactive 8-bit register with real-time GPIO pin state preview</p>
        </div>
        <svg class="card-expand-icon" width="12" height="12" viewBox="0 0 12 12"><path d="M 2 2 L 10 6 L 2 10 Z" fill="currentColor"/></svg>
      </div>
      <div class="card-body" id="gpio-reg-body">
        <div class="card-content">

          <div class="content-block">
            <h3>GPIO Configuration Bits</h3>
            <p>Each GPIO pin on the ESP32 is controlled by a configuration register. The bits below represent a simplified view of the key fields: <strong>mode</strong> (input, output, open-drain, disabled), <strong>pull resistors</strong>, <strong>drive strength</strong>, and <strong>interrupt type</strong>. Click any bit to toggle it and see the effect on the pin configuration.</p>
          </div>

          <div class="viz-container" id="gpioViz">
            <div class="viz-header">
              <span class="viz-label">GPIO Config Register</span>
              <div class="viz-controls">
                <button class="viz-btn" id="gpioAutoBtn" onclick="gpioAutoToggle()" aria-label="Toggle auto mode">Auto</button>
                <button class="viz-btn" onclick="gpioReset()" aria-label="Reset register">Reset</button>
              </div>
            </div>
            <div class="viz-canvas">
              <div class="gpio-reg-viz">
                <div class="gpio-bits-row" id="gpioBitsRow"></div>
                <div class="gpio-preview" id="gpioPreview"></div>
              </div>
            </div>
          </div>

          <div class="content-block">
            <h3>GPIO Configuration in ESP-IDF</h3>
            <div class="code-block"><span class="type">gpio_config_t</span> io_conf = {
    .pin_bit_mask = (<span class="num">1ULL</span> &lt;&lt; <span class="macro">GPIO_NUM_18</span>),
    .mode         = <span class="macro">GPIO_MODE_OUTPUT</span>,
    .pull_up_en   = <span class="macro">GPIO_PULLUP_DISABLE</span>,
    .pull_down_en = <span class="macro">GPIO_PULLDOWN_DISABLE</span>,
    .intr_type    = <span class="macro">GPIO_INTR_DISABLE</span>,
};
<span class="fn">gpio_config</span>(&amp;io_conf);</div>
          </div>

          <button class="deep-dive-btn" onclick="openModal('gpio-modal')" aria-label="Deep dive into GPIO Matrix">IO_MUX vs GPIO Matrix</button>
        </div>
      </div>
    </article>

  </div><!-- end sections-container -->

  <!-- Footer -->
  <footer class="site-footer">
    <span class="pad-dot sm"></span>
    <span class="pad-dot sm"></span>
    <span class="pad-dot sm"></span>
    <p>ESP32 Peripherals &amp; Communication &mdash; Reference Implementation</p>
    <p>Built with <a href="#">Claude Code Technical Visualizer</a></p>
  </footer>

</main>

<!-- ===== Modal Content Templates ===== -->
<template id="pwm-modal">
  <h4>PWM Resolution &amp; Frequency Trade-off</h4>
  <p>The LEDC peripheral uses a timer with configurable bit resolution. Higher resolution means finer duty cycle control but limits maximum frequency:</p>
  <ul>
    <li><strong>13-bit resolution</strong> (8192 steps) at 80 MHz source clock gives max ~9.7 kHz</li>
    <li><strong>10-bit resolution</strong> (1024 steps) allows up to ~78 kHz</li>
    <li><strong>8-bit resolution</strong> (256 steps) can reach ~312 kHz</li>
  </ul>
  <p>The formula: <strong>freq = source_clk / (2^resolution)</strong></p>
  <div class="warn">When using high frequencies for motor control or audio, lower resolution may cause audible stepping. Choose the resolution that balances precision with your frequency requirement.</div>
  <h4>Hardware Fade</h4>
  <p>The LEDC peripheral supports hardware-assisted duty cycle fading. You set a target duty and fade time, and the hardware smoothly transitions without CPU intervention:</p>
  <div class="code-block"><span class="fn">ledc_set_fade_with_time</span>(speed_mode, channel,
    target_duty, fade_time_ms);
<span class="fn">ledc_fade_start</span>(speed_mode, channel,
    <span class="macro">LEDC_FADE_NO_WAIT</span>);</div>
</template>

<template id="wifi-modal">
  <h4>WiFi Event Reference</h4>
  <p>The ESP-IDF WiFi subsystem generates events through the event loop. Key events for station mode:</p>
  <ul>
    <li><strong>WIFI_EVENT_STA_START</strong> &mdash; Station interface initialized, safe to call connect</li>
    <li><strong>WIFI_EVENT_SCAN_DONE</strong> &mdash; Scan completed, results available via esp_wifi_scan_get_ap_records</li>
    <li><strong>WIFI_EVENT_STA_CONNECTED</strong> &mdash; Associated with AP, waiting for IP via DHCP</li>
    <li><strong>IP_EVENT_STA_GOT_IP</strong> &mdash; DHCP complete, fully connected with IP address</li>
    <li><strong>WIFI_EVENT_STA_DISCONNECTED</strong> &mdash; Lost connection, reason code available in event data</li>
  </ul>
  <h4>Common Disconnect Reasons</h4>
  <ul>
    <li><strong>Reason 2</strong> &mdash; Auth expire (re-auth needed)</li>
    <li><strong>Reason 15</strong> &mdash; 4-way handshake timeout (wrong password or signal issue)</li>
    <li><strong>Reason 201</strong> &mdash; No AP found (SSID not in range)</li>
    <li><strong>Reason 202</strong> &mdash; Auth fail (incorrect credentials)</li>
  </ul>
  <div class="warn">Always implement exponential backoff for reconnection attempts. Rapid retries can cause the AP to temporarily block the ESP32 MAC address.</div>
</template>

<template id="gpio-modal">
  <h4>IO_MUX vs GPIO Matrix</h4>
  <p>The ESP32 has two ways to connect peripheral signals to GPIO pins:</p>
  <ul>
    <li><strong>IO_MUX</strong> &mdash; Direct routing with minimal delay. Each pin has a fixed set of peripheral functions available through IO_MUX. Used for high-speed signals like SPI in 80MHz mode.</li>
    <li><strong>GPIO Matrix</strong> &mdash; Flexible routing that can connect any peripheral signal to almost any GPIO pin. Adds approximately one clock cycle of delay but provides enormous flexibility.</li>
  </ul>
  <p>When you call gpio_config() or peripheral-specific setup functions, ESP-IDF chooses the appropriate routing automatically. For most use cases, GPIO Matrix latency is negligible.</p>
  <h4>Pin Capabilities</h4>
  <ul>
    <li><strong>GPIO 0, 2, 4, 12-15</strong> &mdash; RTC GPIOs, usable during deep sleep for wake-up</li>
    <li><strong>GPIO 34-39</strong> &mdash; Input only, no internal pull-up/pull-down resistors</li>
    <li><strong>GPIO 6-11</strong> &mdash; Connected to internal SPI flash, do not use</li>
    <li><strong>Drive strength</strong> &mdash; Configurable: 5mA, 10mA, 20mA, 40mA (default 20mA)</li>
  </ul>
  <div class="warn">GPIO 12 (MTDI) controls flash voltage at boot. Pulling it HIGH sets flash to 1.8V which may prevent boot on 3.3V flash modules.</div>
</template>

<script>
/* ===================================================================
   GLOBAL STATE
   =================================================================== */
let motionReduced = false;

/* ===================================================================
   NAVIGATION
   =================================================================== */
function toggleNav() {
  const nav = document.querySelector('.nav-sidebar');
  nav.classList.toggle('collapsed');
}

function updateActiveNav() {
  const sections = document.querySelectorAll('.section-card, .hero');
  const links = document.querySelectorAll('.nav-links a');
  const scrollY = window.scrollY + 120;

  let current = '';
  sections.forEach(s => {
    if (s.offsetTop <= scrollY) current = s.id;
  });

  links.forEach(a => {
    a.classList.toggle('active', a.getAttribute('href') === '#' + current);
  });
}
window.addEventListener('scroll', updateActiveNav, { passive: true });

/* ===================================================================
   MOTION TOGGLE
   =================================================================== */
function toggleMotion() {
  motionReduced = !motionReduced;
  document.body.classList.toggle('reduce-motion', motionReduced);
  const btn = document.getElementById('motionToggle');
  btn.classList.toggle('paused', motionReduced);
  btn.querySelector('.motion-label').textContent = motionReduced ? 'Animations OFF' : 'Animations ON';
}

/* ===================================================================
   CARD EXPAND/COLLAPSE
   =================================================================== */
function toggleCard(header) {
  const card = header.closest('.section-card');
  const wasExpanded = card.classList.contains('expanded');
  card.classList.toggle('expanded');
  header.setAttribute('aria-expanded', !wasExpanded);
}
document.addEventListener('keydown', e => {
  if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('card-header')) {
    e.preventDefault();
    toggleCard(e.target);
  }
});

/* ===================================================================
   MODAL SYSTEM
   =================================================================== */
function openModal(templateId) {
  const tmpl = document.getElementById(templateId);
  if (!tmpl) return;
  const backdrop = document.getElementById('modalBackdrop');
  const modal = document.getElementById('modal');
  const body = document.getElementById('modalBody');
  const title = document.getElementById('modalTitleText');

  body.innerHTML = tmpl.innerHTML;
  const h4 = body.querySelector('h4');
  title.textContent = h4 ? h4.textContent : 'Deep Dive';

  backdrop.classList.add('visible');
  modal.classList.add('visible');
  modal.querySelector('.modal-close').focus();
}

function closeModal() {
  document.getElementById('modalBackdrop').classList.remove('visible');
  document.getElementById('modal').classList.remove('visible');
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

/* ===================================================================
   1. PWM SIGNAL GENERATION (Playhead / Sweep)
   =================================================================== */
const pwmChannels = [
  { duty: 0.25, color: '#60a5fa' },
  { duty: 0.50, color: '#4ade80' },
  { duty: 0.75, color: '#d4924b' },
];
const PWM_PERIOD_PX_COUNT = 4;
let pwmPlaying = true;
let pwmAnimId = null;
let pwmPosition = 0;
let pwmLastTime = 0;
const PWM_SPEED = 0.15;

function pwmRender() {
  pwmChannels.forEach((ch, i) => {
    const track = document.getElementById('pwmTrack' + i);
    const blocksEl = document.getElementById('pwmBlocks' + i);
    const cursor = document.getElementById('pwmCursor' + i);
    if (!track) return;

    const trackW = track.clientWidth;
    const periodW = trackW / PWM_PERIOD_PX_COUNT;
    const cursorX = pwmPosition * trackW;

    cursor.style.left = cursorX + 'px';

    let html = '';
    const totalPeriods = Math.ceil(cursorX / periodW) + 1;
    for (let p = 0; p < totalPeriods; p++) {
      const periodStart = p * periodW;
      const highW = periodW * ch.duty;
      const lowW = periodW * (1 - ch.duty);
      const highEnd = periodStart + highW;

      if (periodStart < cursorX) {
        const visibleHighW = Math.min(highW, cursorX - periodStart);
        if (visibleHighW > 0) {
          html += '<div class="pwm-block" style="width:' + visibleHighW + 'px;background:' + ch.color + ';opacity:0.85;"></div>';
        }
        if (cursorX > highEnd) {
          const visibleLowW = Math.min(lowW, cursorX - highEnd);
          if (visibleLowW > 0) {
            html += '<div class="pwm-block" style="width:' + visibleLowW + 'px;background:' + ch.color + ';opacity:0.15;"></div>';
          }
        }
      }
    }
    blocksEl.innerHTML = html;
  });
}

function pwmStep(timestamp) {
  if (!pwmLastTime) pwmLastTime = timestamp;
  const dt = (timestamp - pwmLastTime) / 1000;
  pwmLastTime = timestamp;

  if (pwmPlaying && !motionReduced) {
    pwmPosition += PWM_SPEED * dt;
    if (pwmPosition > 1) pwmPosition = 0;
  }

  pwmRender();
  pwmAnimId = requestAnimationFrame(pwmStep);
}

function pwmToggle() {
  pwmPlaying = !pwmPlaying;
  const btn = document.getElementById('pwmPlayBtn');
  btn.textContent = pwmPlaying ? 'Pause' : 'Play';
  btn.classList.toggle('active', pwmPlaying);
}

function pwmReset() {
  pwmPosition = 0;
  pwmLastTime = 0;
  pwmRender();
}

/* ===================================================================
   2. WIFI CONNECTION FSM (State Machine)
   =================================================================== */
const fsmNodes = [
  { id: 'idle',         label: 'IDLE',         x: 50,  y: 40  },
  { id: 'scanning',     label: 'SCANNING',     x: 250, y: 40  },
  { id: 'connecting',   label: 'CONNECTING',   x: 450, y: 40  },
  { id: 'connected',    label: 'CONNECTED',    x: 450, y: 200 },
  { id: 'disconnected', label: 'DISCONNECTED', x: 250, y: 200 },
  { id: 'error',        label: 'ERROR',        x: 50,  y: 200 },
];
const fsmEdges = [
  { from: 'idle',         to: 'scanning'     },
  { from: 'scanning',     to: 'connecting'   },
  { from: 'connecting',   to: 'connected'    },
  { from: 'connected',    to: 'disconnected' },
  { from: 'disconnected', to: 'connecting'   },
  { from: 'disconnected', to: 'error'        },
  { from: 'error',        to: 'idle'         },
  { from: 'scanning',     to: 'error'        },
];
const fsmScenario = [
  { state: 'idle',         event: 'WiFi initialized', duration: 1500 },
  { state: 'scanning',     event: 'WIFI_EVENT_SCAN_DONE', duration: 2000 },
  { state: 'connecting',   event: 'Associating with AP...', duration: 2000 },
  { state: 'connected',    event: 'IP_EVENT_STA_GOT_IP: 192.168.1.42', duration: 3000 },
  { state: 'disconnected', event: 'WIFI_EVENT_STA_DISCONNECTED (reason: 200)', duration: 1500 },
  { state: 'connecting',   event: 'Reconnect attempt 1/5', duration: 1500 },
  { state: 'connected',    event: 'IP_EVENT_STA_GOT_IP: 192.168.1.42', duration: 3000 },
  { state: 'disconnected', event: 'WIFI_EVENT_STA_DISCONNECTED (reason: 201)', duration: 1200 },
  { state: 'connecting',   event: 'Reconnect attempt 2/5', duration: 1200 },
  { state: 'disconnected', event: 'WIFI_EVENT_STA_DISCONNECTED (reason: 201)', duration: 1200 },
  { state: 'error',        event: 'Max retries exceeded', duration: 2000 },
  { state: 'idle',         event: 'System reset', duration: 2000 },
];

let wifiPlaying = true;
let wifiAnimId = null;
let wifiScenarioIdx = 0;
let wifiCurrentState = 'idle';
let wifiLastTime = 0;
let wifiStepElapsed = 0;

function wifiGetNode(id) {
  return fsmNodes.find(n => n.id === id);
}

function wifiRenderInit() {
  const container = document.getElementById('wifiCanvas');
  container.innerHTML = '';
  container.style.minHeight = '280px';

  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.classList.add('fsm-svg');
  svg.id = 'fsmSvg';
  svg.setAttribute('viewBox', '0 0 600 280');
  svg.setAttribute('preserveAspectRatio', 'xMidYMid meet');

  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');

  const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  marker.setAttribute('id', 'arrowhead');
  marker.setAttribute('markerWidth', '8');
  marker.setAttribute('markerHeight', '6');
  marker.setAttribute('refX', '8');
  marker.setAttribute('refY', '3');
  marker.setAttribute('orient', 'auto');
  const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  poly.setAttribute('points', '0 0, 8 3, 0 6');
  poly.setAttribute('fill', 'var(--border-color)');
  poly.id = 'arrowPoly';
  marker.appendChild(poly);
  defs.appendChild(marker);

  const markerActive = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
  markerActive.setAttribute('id', 'arrowheadActive');
  markerActive.setAttribute('markerWidth', '8');
  markerActive.setAttribute('markerHeight', '6');
  markerActive.setAttribute('refX', '8');
  markerActive.setAttribute('refY', '3');
  markerActive.setAttribute('orient', 'auto');
  const polyActive = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  polyActive.setAttribute('points', '0 0, 8 3, 0 6');
  polyActive.setAttribute('fill', 'var(--green)');
  markerActive.appendChild(polyActive);
  defs.appendChild(markerActive);

  svg.appendChild(defs);

  fsmEdges.forEach((edge, i) => {
    const from = wifiGetNode(edge.from);
    const to = wifiGetNode(edge.to);
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', from.x + 55);
    line.setAttribute('y1', from.y + 20);
    line.setAttribute('x2', to.x);
    line.setAttribute('y2', to.y + 20);
    line.setAttribute('marker-end', 'url(#arrowhead)');
    line.id = 'fsmEdge' + i;
    svg.appendChild(line);
  });

  container.appendChild(svg);

  fsmNodes.forEach(node => {
    const div = document.createElement('div');
    div.className = 'fsm-node' + (node.id === 'error' ? ' error-state' : '');
    div.id = 'fsmNode_' + node.id;
    div.style.left = node.x + 'px';
    div.style.top = node.y + 'px';
    div.textContent = node.label;
    container.appendChild(div);
  });

  wifiRender();
}

function wifiRender() {
  fsmNodes.forEach(node => {
    const el = document.getElementById('fsmNode_' + node.id);
    if (el) {
      el.classList.toggle('active', node.id === wifiCurrentState);
    }
  });

  const scenario = fsmScenario[wifiScenarioIdx];
  const prevState = wifiScenarioIdx > 0 ? fsmScenario[wifiScenarioIdx - 1].state : null;

  fsmEdges.forEach((edge, i) => {
    const line = document.getElementById('fsmEdge' + i);
    if (line) {
      const isActive = edge.from === prevState && edge.to === wifiCurrentState;
      line.classList.toggle('active', isActive);
      line.setAttribute('marker-end', isActive ? 'url(#arrowheadActive)' : 'url(#arrowhead)');
    }
  });

  const eventText = document.getElementById('wifiEventText');
  if (eventText && scenario) {
    eventText.textContent = scenario.event;
  }
}

function wifiStep(timestamp) {
  if (!wifiLastTime) wifiLastTime = timestamp;
  const dt = timestamp - wifiLastTime;
  wifiLastTime = timestamp;

  if (wifiPlaying && !motionReduced) {
    wifiStepElapsed += dt;
    const scenario = fsmScenario[wifiScenarioIdx];
    if (wifiStepElapsed >= scenario.duration) {
      wifiStepElapsed = 0;
      wifiScenarioIdx = (wifiScenarioIdx + 1) % fsmScenario.length;
      wifiCurrentState = fsmScenario[wifiScenarioIdx].state;
      wifiRender();
    }
  }

  wifiAnimId = requestAnimationFrame(wifiStep);
}

function wifiToggle() {
  wifiPlaying = !wifiPlaying;
  const btn = document.getElementById('wifiPlayBtn');
  btn.textContent = wifiPlaying ? 'Pause' : 'Play';
  btn.classList.toggle('active', wifiPlaying);
}

function wifiReset() {
  wifiScenarioIdx = 0;
  wifiCurrentState = 'idle';
  wifiStepElapsed = 0;
  wifiLastTime = 0;
  wifiRender();
}

/* ===================================================================
   3. GPIO CONFIGURATION REGISTER (Bit Register)
   =================================================================== */
const gpioBitDefs = [
  { label: 'Mode[0]', group: 'mode' },
  { label: 'Mode[1]', group: 'mode' },
  { label: 'Pull-up', group: 'pull' },
  { label: 'Pull-dn', group: 'pull' },
  { label: 'Drive[0]', group: 'drive' },
  { label: 'Drive[1]', group: 'drive' },
  { label: 'IRQ[0]', group: 'irq' },
  { label: 'IRQ[1]', group: 'irq' },
];
let gpioBits = [0, 0, 0, 0, 0, 0, 0, 0];
let gpioAutoMode = false;
let gpioAutoId = null;

function gpioBuildUI() {
  const row = document.getElementById('gpioBitsRow');
  if (!row) return;
  let html = '';
  for (let i = 7; i >= 0; i--) {
    html += '<div class="gpio-bit" onclick="gpioToggleBit(' + i + ')" role="switch" aria-checked="' + (gpioBits[i] === 1) + '" tabindex="0">' +
      '<span class="gpio-bit-num">bit ' + i + '</span>' +
      '<div class="gpio-bit-box" id="gpioBitBox' + i + '">' + gpioBits[i] + '</div>' +
      '<span class="gpio-bit-label">' + gpioBitDefs[i].label + '</span>' +
    '</div>';
  }
  row.innerHTML = html;
  gpioUpdatePreview();
}

function gpioToggleBit(i) {
  gpioBits[i] = gpioBits[i] ? 0 : 1;
  const box = document.getElementById('gpioBitBox' + i);
  box.textContent = gpioBits[i];
  box.classList.toggle('set', gpioBits[i] === 1);
  // Update ARIA on parent
  box.parentElement.setAttribute('aria-checked', gpioBits[i] === 1);
  gpioUpdatePreview();
}

function gpioUpdatePreview() {
  const mode = (gpioBits[1] << 1) | gpioBits[0];
  const pullUp = gpioBits[2];
  const pullDown = gpioBits[3];
  const drive = (gpioBits[5] << 1) | gpioBits[4];
  const irq = (gpioBits[7] << 1) | gpioBits[6];

  const modeNames = ['Input', 'Output', 'Open-Drain', 'Disabled'];
  const driveNames = ['5 mA', '10 mA', '20 mA', '40 mA'];
  const irqNames = ['Disabled', 'Rising Edge', 'Falling Edge', 'Any Edge'];
  const modeName = modeNames[mode];
  const pinClasses = ['input', 'output', 'od', 'off'];
  const pinSymbols = ['\u2190', '\u2192', '\u21C5', '\u00D7'];

  const preview = document.getElementById('gpioPreview');
  preview.innerHTML =
    '<div class="gpio-pin-graphic ' + pinClasses[mode] + '">' + pinSymbols[mode] + '</div>' +
    '<div class="gpio-preview-item"><span class="gpio-preview-label">Mode</span><span class="gpio-preview-val ' + (mode === 3 ? 'disabled' : 'active') + '">' + modeName + '</span></div>' +
    '<div class="gpio-preview-item"><span class="gpio-preview-label">Pull-up</span><span class="gpio-preview-val ' + (pullUp ? 'active' : '') + '">' + (pullUp ? 'ON' : 'OFF') + '</span></div>' +
    '<div class="gpio-preview-item"><span class="gpio-preview-label">Pull-down</span><span class="gpio-preview-val ' + (pullDown ? 'active' : '') + '">' + (pullDown ? 'ON' : 'OFF') + '</span></div>' +
    '<div class="gpio-preview-item"><span class="gpio-preview-label">Drive</span><span class="gpio-preview-val">' + driveNames[drive] + '</span></div>' +
    '<div class="gpio-preview-item"><span class="gpio-preview-label">Interrupt</span><span class="gpio-preview-val ' + (irq ? 'active' : '') + '">' + irqNames[irq] + '</span></div>';

  for (let j = 0; j < 8; j++) {
    const b = document.getElementById('gpioBitBox' + j);
    if (b) {
      b.textContent = gpioBits[j];
      b.classList.toggle('set', gpioBits[j] === 1);
    }
  }
}

function gpioAutoStep() {
  if (!gpioAutoMode || motionReduced) return;
  const bit = Math.floor(Math.random() * 8);
  gpioToggleBit(bit);
  gpioAutoId = setTimeout(gpioAutoStep, 600 + Math.random() * 800);
}

function gpioAutoToggle() {
  gpioAutoMode = !gpioAutoMode;
  const btn = document.getElementById('gpioAutoBtn');
  btn.classList.toggle('active', gpioAutoMode);
  btn.textContent = gpioAutoMode ? 'Stop' : 'Auto';
  if (gpioAutoMode) gpioAutoStep();
  else { clearTimeout(gpioAutoId); gpioAutoId = null; }
}

function gpioReset() {
  clearTimeout(gpioAutoId); gpioAutoId = null;
  gpioAutoMode = false;
  const btn = document.getElementById('gpioAutoBtn');
  if (btn) { btn.classList.remove('active'); btn.textContent = 'Auto'; }
  gpioBits = [0, 0, 0, 0, 0, 0, 0, 0];
  gpioBuildUI();
}

/* ===================================================================
   KEYBOARD SUPPORT FOR GPIO BITS
   =================================================================== */
document.addEventListener('keydown', e => {
  if (e.target.matches('.gpio-bit[role="switch"]')) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      const box = e.target.querySelector('.gpio-bit-box');
      if (box) {
        const idx = parseInt(box.id.replace('gpioBitBox', ''));
        gpioToggleBit(idx);
      }
    }
  }
});

/* ===================================================================
   INTERSECTION OBSERVER & INITIALIZATION
   =================================================================== */
function init() {
  pwmRender();
  wifiRenderInit();
  gpioBuildUI();

  const vizObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const id = entry.target.id;
      if (entry.isIntersecting) {
        if (id === 'pwmViz' && !pwmAnimId) { pwmLastTime = 0; pwmAnimId = requestAnimationFrame(pwmStep); }
        if (id === 'wifiViz' && !wifiAnimId) { wifiLastTime = 0; wifiAnimId = requestAnimationFrame(wifiStep); }
        if (id === 'gpioViz' && !gpioAutoId && gpioAutoMode) { gpioAutoStep(); }
      } else {
        if (id === 'pwmViz') { cancelAnimationFrame(pwmAnimId); pwmAnimId = null; }
        if (id === 'wifiViz') { cancelAnimationFrame(wifiAnimId); wifiAnimId = null; }
        if (id === 'gpioViz') { clearTimeout(gpioAutoId); gpioAutoId = null; }
      }
    });
  }, { threshold: 0.1 });

  ['pwmViz', 'wifiViz', 'gpioViz'].forEach(id => {
    const el = document.getElementById(id);
    if (el) vizObserver.observe(el);
  });

  // Check system motion preference
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
    motionReduced = true;
    document.body.classList.add('reduce-motion');
    const btn = document.getElementById('motionToggle');
    if (btn) {
      btn.classList.add('paused');
      btn.querySelector('.motion-label').textContent = 'Animations OFF';
    }
  }

  updateActiveNav();

  // Open first card by default
  const firstCard = document.querySelector('.section-card');
  if (firstCard) {
    firstCard.classList.add('expanded');
    firstCard.querySelector('.card-header').setAttribute('aria-expanded', 'true');
  }

  // Close mobile nav on link click
  document.querySelectorAll('.nav-links a').forEach(link => {
    link.addEventListener('click', () => {
      if (window.innerWidth <= 768) {
        document.querySelector('.nav-sidebar').classList.remove('mobile-open');
      }
    });
  });

  // Resize handler
  window.addEventListener('resize', () => {
    pwmRender();
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
